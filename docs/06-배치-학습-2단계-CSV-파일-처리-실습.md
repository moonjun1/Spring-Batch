# 06. ë°°ì¹˜ í•™ìŠµ 2ë‹¨ê³„: CSV íŒŒì¼ ì²˜ë¦¬ ì‹¤ìŠµ

## ğŸ¯ í•™ìŠµ ëª©í‘œ
- ItemReader, ItemProcessor, ItemWriter ì‹¤ì „ êµ¬í˜„
- CSV íŒŒì¼ì„ ì½ì–´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì™„ì „í•œ ë°°ì¹˜ ì‹œìŠ¤í…œ êµ¬ì¶•
- ì²­í¬ ê¸°ë°˜ ì²˜ë¦¬ ì´í•´ ë° ìµœì í™”
- ë°ì´í„° ê²€ì¦ ë° ë³€í™˜ ë¡œì§ êµ¬í˜„

## ğŸ“‚ í”„ë¡œì íŠ¸ ì¤€ë¹„

### 1. ì˜ì¡´ì„± ì¶”ê°€ (build.gradle)
```gradle
dependencies {
    // ê¸°ì¡´ ì˜ì¡´ì„±ë“¤...
    
    // CSV ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¶”ê°€ ì˜ì¡´ì„±
    implementation 'org.springframework.batch:spring-batch-core'
    implementation 'org.springframework.boot:spring-boot-starter-batch'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    
    // ê²€ì¦ì„ ìœ„í•œ ì˜ì¡´ì„±
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    
    // ìœ í‹¸ë¦¬í‹°
    implementation 'org.apache.commons:commons-csv:1.10.0'
}
```

### 2. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„

#### CSV íŒŒì¼ ìƒì„± (src/main/resources/data/employees.csv):
```csv
firstName,lastName,email,department,salary,hireDate
ê¹€,ì² ìˆ˜,kim.chulsoo@company.com,ê°œë°œíŒ€,5500000,2023-01-15
ì´,ì˜í¬,lee.younghee@company.com,ë§ˆì¼€íŒ…íŒ€,4800000,2023-02-20
ë°•,ë¯¼ìˆ˜,park.minsoo@company.com,ê°œë°œíŒ€,6200000,2022-11-10
ìµœ,ìˆ˜ì§„,choi.sujin@company.com,ì¸ì‚¬íŒ€,5000000,2023-03-05
ì •,í˜¸ì˜,jung.hoyoung@company.com,ì˜ì—…íŒ€,4500000,2023-01-30
ê°•,ë¯¸ì˜,kang.miyoung@company.com,ê°œë°œíŒ€,7000000,2022-08-15
ìœ¤,ëŒ€í˜¸,yoon.daeho@company.com,ê¸°íšíŒ€,5800000,2023-02-10
ì†¡,ì§€ë¯¼,song.jimin@company.com,ê°œë°œíŒ€,5200000,2023-04-01
ì¡°,í˜„ìš°,cho.hyunwoo@company.com,ë§ˆì¼€íŒ…íŒ€,4700000,2023-01-25
í•œ,ì„œì—°,han.seoyeon@company.com,ì¸ì‚¬íŒ€,5300000,2022-12-05
```

#### ì˜ëª»ëœ ë°ì´í„°ê°€ í¬í•¨ëœ CSV (src/main/resources/data/employees-with-errors.csv):
```csv
firstName,lastName,email,department,salary,hireDate
ê¹€,ì² ìˆ˜,kim.chulsoo@company.com,ê°œë°œíŒ€,5500000,2023-01-15
ì´,ì˜í¬,invalid-email,ë§ˆì¼€íŒ…íŒ€,4800000,2023-02-20
ë°•,,park.minsoo@company.com,ê°œë°œíŒ€,6200000,2022-11-10
ìµœ,ìˆ˜ì§„,choi.sujin@company.com,,5000000,2023-03-05
ì •,í˜¸ì˜,jung.hoyoung@company.com,ì˜ì—…íŒ€,-1000,2023-01-30
ê°•,ë¯¸ì˜,kang.miyoung@company.com,ê°œë°œíŒ€,7000000,invalid-date
```

## ğŸ—ï¸ ì—”í‹°í‹° ë° DTO í´ë˜ìŠ¤ êµ¬í˜„

### 1. Employee ì—”í‹°í‹° í´ë˜ìŠ¤
```java
package com.example.batchtutorial.entity;

import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * ì§ì› ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” JPA ì—”í‹°í‹°
 */
@Entity
@Table(name = "employees")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Employee {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "first_name", nullable = false, length = 50)
    @NotBlank(message = "ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String firstName;
    
    @Column(name = "last_name", nullable = false, length = 50)
    @NotBlank(message = "ì„±ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String lastName;
    
    @Column(name = "email", nullable = false, unique = true, length = 100)
    @Email(message = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    @NotBlank(message = "ì´ë©”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String email;
    
    @Column(name = "department", nullable = false, length = 50)
    @NotBlank(message = "ë¶€ì„œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String department;
    
    @Column(name = "salary", nullable = false, precision = 10, scale = 2)
    @DecimalMin(value = "0.0", message = "ê¸‰ì—¬ëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤")
    @NotNull(message = "ê¸‰ì—¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    private BigDecimal salary;
    
    @Column(name = "hire_date", nullable = false)
    @NotNull(message = "ì…ì‚¬ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @PastOrPresent(message = "ì…ì‚¬ì¼ì€ í˜„ì¬ ë˜ëŠ” ê³¼ê±° ë‚ ì§œì—¬ì•¼ í•©ë‹ˆë‹¤")
    private LocalDate hireDate;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    // ìƒì„±/ìˆ˜ì • ì‹œê°„ ìë™ ì„¤ì •
    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
    
    // ì „ì²´ ì´ë¦„ ë°˜í™˜ í—¬í¼ ë©”ì„œë“œ
    public String getFullName() {
        return firstName + " " + lastName;
    }
}
```

### 2. CSV ë°ì´í„°ìš© DTO í´ë˜ìŠ¤
```java
package com.example.batchtutorial.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * CSV íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì›ì‹œ ë°ì´í„°ë¥¼ ë‹´ëŠ” DTO
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class EmployeeCsvDto {
    
    private String firstName;
    private String lastName;
    private String email;
    private String department;
    private String salary;        // ë¬¸ìì—´ë¡œ ë°›ì•„ì„œ ê²€ì¦ í›„ ë³€í™˜
    private String hireDate;      // ë¬¸ìì—´ë¡œ ë°›ì•„ì„œ ë‚ ì§œ ë³€í™˜
}
```

### 3. Repository ì¸í„°í˜ì´ìŠ¤
```java
package com.example.batchtutorial.repository;

import com.example.batchtutorial.entity.Employee;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.math.BigDecimal;
import java.util.List;
import java.util.Optional;

@Repository
public interface EmployeeRepository extends JpaRepository<Employee, Long> {
    
    // ì´ë©”ì¼ë¡œ ì§ì› ì¡°íšŒ (ì¤‘ë³µ ì²´í¬ìš©)
    Optional<Employee> findByEmail(String email);
    
    // ë¶€ì„œë³„ ì§ì› ëª©ë¡ ì¡°íšŒ
    List<Employee> findByDepartmentOrderByLastNameAsc(String department);
    
    // ê¸‰ì—¬ ë²”ìœ„ë¡œ ì§ì› ì¡°íšŒ
    List<Employee> findBySalaryBetweenOrderBySalaryDesc(BigDecimal minSalary, BigDecimal maxSalary);
    
    // ë¶€ì„œë³„ í‰ê·  ê¸‰ì—¬ ê³„ì‚°
    @Query("SELECT e.department, AVG(e.salary) FROM Employee e GROUP BY e.department")
    List<Object[]> findAverageSalaryByDepartment();
    
    // ìµœê·¼ ì…ì‚¬ì ì¡°íšŒ
    @Query("SELECT e FROM Employee e ORDER BY e.hireDate DESC")
    List<Employee> findRecentHires();
}
```

## ğŸ”§ ë°°ì¹˜ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„

### 1. ItemReader - CSV íŒŒì¼ ì½ê¸°
```java
package com.example.batchtutorial.batch;

import com.example.batchtutorial.dto.EmployeeCsvDto;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.item.file.FlatFileItemReader;
import org.springframework.batch.item.file.builder.FlatFileItemReaderBuilder;
import org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;

/**
 * CSV íŒŒì¼ì„ ì½ëŠ” ItemReader ì„¤ì •
 */
@Slf4j
@Configuration
public class EmployeeItemReaderConfig {
    
    @Bean
    public FlatFileItemReader<EmployeeCsvDto> employeeCsvReader() {
        return new FlatFileItemReaderBuilder<EmployeeCsvDto>()
                .name("employeeCsvReader")
                .resource(new ClassPathResource("data/employees.csv"))
                .delimited()
                .delimiter(",")
                .names("firstName", "lastName", "email", "department", "salary", "hireDate")
                .linesToSkip(1)  // ì²« ë²ˆì§¸ ë¼ì¸(í—¤ë”) ìŠ¤í‚µ
                .fieldSetMapper(new BeanWrapperFieldSetMapper<EmployeeCsvDto>() {{
                    setTargetType(EmployeeCsvDto.class);
                }})
                .build();
    }
    
    /**
     * ì—ëŸ¬ê°€ ìˆëŠ” CSV íŒŒì¼ì„ ì½ëŠ” Reader (ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ìš©)
     */
    @Bean
    public FlatFileItemReader<EmployeeCsvDto> employeeCsvReaderWithErrors() {
        return new FlatFileItemReaderBuilder<EmployeeCsvDto>()
                .name("employeeCsvReaderWithErrors")
                .resource(new ClassPathResource("data/employees-with-errors.csv"))
                .delimited()
                .delimiter(",")
                .names("firstName", "lastName", "email", "department", "salary", "hireDate")
                .linesToSkip(1)
                .fieldSetMapper(new BeanWrapperFieldSetMapper<EmployeeCsvDto>() {{
                    setTargetType(EmployeeCsvDto.class);
                }})
                .build();
    }
}
```

### 2. ItemProcessor - ë°ì´í„° ë³€í™˜ ë° ê²€ì¦
```java
package com.example.batchtutorial.batch;

import com.example.batchtutorial.dto.EmployeeCsvDto;
import com.example.batchtutorial.entity.Employee;
import com.example.batchtutorial.exception.DataValidationException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.item.ItemProcessor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.regex.Pattern;

/**
 * CSV ë°ì´í„°ë¥¼ Employee ì—”í‹°í‹°ë¡œ ë³€í™˜í•˜ëŠ” ItemProcessor
 */
@Slf4j
@Configuration
public class EmployeeItemProcessorConfig {
    
    private static final Pattern EMAIL_PATTERN = Pattern.compile(
            "^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$"
    );
    
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    
    @Bean
    public ItemProcessor<EmployeeCsvDto, Employee> employeeProcessor() {
        return new ItemProcessor<EmployeeCsvDto, Employee>() {
            @Override
            public Employee process(EmployeeCsvDto csvDto) throws Exception {
                
                log.debug("Processing employee: {} {}", csvDto.getFirstName(), csvDto.getLastName());
                
                try {
                    // 1. ê¸°ë³¸ í•„ë“œ ê²€ì¦
                    validateRequiredFields(csvDto);
                    
                    // 2. Employee ì—”í‹°í‹° ìƒì„±
                    Employee employee = new Employee();
                    
                    // 3. ê¸°ë³¸ ì •ë³´ ì„¤ì •
                    employee.setFirstName(csvDto.getFirstName().trim());
                    employee.setLastName(csvDto.getLastName().trim());
                    employee.setDepartment(csvDto.getDepartment().trim());
                    
                    // 4. ì´ë©”ì¼ ê²€ì¦ ë° ì„¤ì •
                    String email = validateAndProcessEmail(csvDto.getEmail());
                    employee.setEmail(email);
                    
                    // 5. ê¸‰ì—¬ ê²€ì¦ ë° ì„¤ì •
                    BigDecimal salary = validateAndProcessSalary(csvDto.getSalary());
                    employee.setSalary(salary);
                    
                    // 6. ì…ì‚¬ì¼ ê²€ì¦ ë° ì„¤ì •
                    LocalDate hireDate = validateAndProcessHireDate(csvDto.getHireDate());
                    employee.setHireDate(hireDate);
                    
                    log.info("Successfully processed employee: {}", employee.getFullName());
                    return employee;
                    
                } catch (DataValidationException e) {
                    log.warn("Validation failed for employee {}: {}", 
                            csvDto.getFirstName() + " " + csvDto.getLastName(), e.getMessage());
                    return null;  // null ë°˜í™˜ ì‹œ í•´ë‹¹ ì•„ì´í…œì€ writerë¡œ ì „ë‹¬ë˜ì§€ ì•ŠìŒ
                    
                } catch (Exception e) {
                    log.error("Unexpected error processing employee {}: {}", 
                            csvDto.getFirstName() + " " + csvDto.getLastName(), e.getMessage());
                    throw e;  // ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ëŠ” ì¬ë°œìƒì‹œì¼œ ë°°ì¹˜ ì¤‘ë‹¨
                }
            }
        };
    }
    
    /**
     * í•„ìˆ˜ í•„ë“œ ê²€ì¦
     */
    private void validateRequiredFields(EmployeeCsvDto csvDto) throws DataValidationException {
        if (!StringUtils.hasText(csvDto.getFirstName())) {
            throw new DataValidationException("ì´ë¦„ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
        }
        if (!StringUtils.hasText(csvDto.getLastName())) {
            throw new DataValidationException("ì„±ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
        }
        if (!StringUtils.hasText(csvDto.getEmail())) {
            throw new DataValidationException("ì´ë©”ì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
        }
        if (!StringUtils.hasText(csvDto.getDepartment())) {
            throw new DataValidationException("ë¶€ì„œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
        }
        if (!StringUtils.hasText(csvDto.getSalary())) {
            throw new DataValidationException("ê¸‰ì—¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
        }
        if (!StringUtils.hasText(csvDto.getHireDate())) {
            throw new DataValidationException("ì…ì‚¬ì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
        }
    }
    
    /**
     * ì´ë©”ì¼ ê²€ì¦ ë° ì²˜ë¦¬
     */
    private String validateAndProcessEmail(String email) throws DataValidationException {
        String processedEmail = email.trim().toLowerCase();
        
        if (!EMAIL_PATTERN.matcher(processedEmail).matches()) {
            throw new DataValidationException("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤: " + email);
        }
        
        return processedEmail;
    }
    
    /**
     * ê¸‰ì—¬ ê²€ì¦ ë° ì²˜ë¦¬
     */
    private BigDecimal validateAndProcessSalary(String salaryStr) throws DataValidationException {
        try {
            BigDecimal salary = new BigDecimal(salaryStr.trim());
            
            if (salary.compareTo(BigDecimal.ZERO) <= 0) {
                throw new DataValidationException("ê¸‰ì—¬ëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤: " + salaryStr);
            }
            
            if (salary.compareTo(new BigDecimal("100000000")) > 0) {
                throw new DataValidationException("ê¸‰ì—¬ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤: " + salaryStr);
            }
            
            return salary;
            
        } catch (NumberFormatException e) {
            throw new DataValidationException("ê¸‰ì—¬ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: " + salaryStr);
        }
    }
    
    /**
     * ì…ì‚¬ì¼ ê²€ì¦ ë° ì²˜ë¦¬
     */
    private LocalDate validateAndProcessHireDate(String hireDateStr) throws DataValidationException {
        try {
            LocalDate hireDate = LocalDate.parse(hireDateStr.trim(), DATE_FORMATTER);
            
            // ì…ì‚¬ì¼ì´ ë¯¸ë˜ë‚ ì§œì¸ì§€ í™•ì¸
            if (hireDate.isAfter(LocalDate.now())) {
                throw new DataValidationException("ì…ì‚¬ì¼ì€ í˜„ì¬ ë‚ ì§œë³´ë‹¤ ë¯¸ë˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + hireDateStr);
            }
            
            // ì…ì‚¬ì¼ì´ ë„ˆë¬´ ê³¼ê±°ì¸ì§€ í™•ì¸ (ì˜ˆ: íšŒì‚¬ ì„¤ë¦½ì¼ ì´ì „)
            LocalDate companyFoundedDate = LocalDate.of(2000, 1, 1);
            if (hireDate.isBefore(companyFoundedDate)) {
                throw new DataValidationException("ì…ì‚¬ì¼ì´ íšŒì‚¬ ì„¤ë¦½ì¼ë³´ë‹¤ ì´ì „ì…ë‹ˆë‹¤: " + hireDateStr);
            }
            
            return hireDate;
            
        } catch (DateTimeParseException e) {
            throw new DataValidationException("ì…ì‚¬ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (yyyy-MM-dd): " + hireDateStr);
        }
    }
}
```

### 3. ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤
```java
package com.example.batchtutorial.exception;

/**
 * ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸
 */
public class DataValidationException extends Exception {
    
    public DataValidationException(String message) {
        super(message);
    }
    
    public DataValidationException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

### 4. ItemWriter - ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
```java
package com.example.batchtutorial.batch;

import com.example.batchtutorial.entity.Employee;
import com.example.batchtutorial.repository.EmployeeRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.item.Chunk;
import org.springframework.batch.item.ItemWriter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.math.BigDecimal;
import java.util.List;

/**
 * Employee ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ItemWriter
 */
@Slf4j
@Configuration
public class EmployeeItemWriterConfig {
    
    @Autowired
    private EmployeeRepository employeeRepository;
    
    @Bean
    public ItemWriter<Employee> employeeWriter() {
        return new ItemWriter<Employee>() {
            @Override
            public void write(Chunk<? extends Employee> chunk) throws Exception {
                
                List<? extends Employee> employees = chunk.getItems();
                log.info("Writing {} employees to database", employees.size());
                
                // í†µê³„ ì •ë³´ ìˆ˜ì§‘
                int savedCount = 0;
                int duplicateCount = 0;
                BigDecimal totalSalary = BigDecimal.ZERO;
                
                for (Employee employee : employees) {
                    try {
                        // ì¤‘ë³µ ì´ë©”ì¼ ì²´í¬
                        if (employeeRepository.findByEmail(employee.getEmail()).isPresent()) {
                            log.warn("Duplicate email found, skipping: {}", employee.getEmail());
                            duplicateCount++;
                            continue;
                        }
                        
                        // ì§ì› ì €ì¥
                        Employee savedEmployee = employeeRepository.save(employee);
                        savedCount++;
                        totalSalary = totalSalary.add(savedEmployee.getSalary());
                        
                        log.debug("Saved employee: {} (ID: {})", 
                                savedEmployee.getFullName(), savedEmployee.getId());
                        
                    } catch (Exception e) {
                        log.error("Failed to save employee: {}", employee.getFullName(), e);
                        throw e;
                    }
                }
                
                // ì²­í¬ ì²˜ë¦¬ ê²°ê³¼ ë¡œê¹…
                log.info("Chunk processing completed - Saved: {}, Duplicates: {}, Total Salary: {}", 
                        savedCount, duplicateCount, totalSalary);
                
                if (savedCount == 0 && duplicateCount > 0) {
                    log.warn("All employees in this chunk were duplicates");
                }
            }
        };
    }
}
```

## ğŸ”§ ë°°ì¹˜ Job ì„¤ì •

### ë©”ì¸ ë°°ì¹˜ ì„¤ì • í´ë˜ìŠ¤
```java
package com.example.batchtutorial.config;

import com.example.batchtutorial.dto.EmployeeCsvDto;
import com.example.batchtutorial.entity.Employee;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.job.builder.JobBuilder;
import org.springframework.batch.core.launch.support.RunIdIncrementer;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.batch.core.step.builder.StepBuilder;
import org.springframework.batch.item.ItemProcessor;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ItemWriter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.PlatformTransactionManager;

/**
 * ì§ì› CSV íŒŒì¼ ì²˜ë¦¬ ë°°ì¹˜ Job ì„¤ì •
 */
@Slf4j
@Configuration
public class EmployeeBatchConfig {
    
    @Autowired
    private JobRepository jobRepository;
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    /**
     * ì§ì› ë°ì´í„° ì²˜ë¦¬ Job
     */
    @Bean
    public Job importEmployeeJob(Step importEmployeeStep) {
        return new JobBuilder("importEmployeeJob", jobRepository)
                .incrementer(new RunIdIncrementer())  // ë§¤ë²ˆ ìƒˆë¡œìš´ JobInstance ìƒì„±
                .flow(importEmployeeStep)
                .end()
                .build();
    }
    
    /**
     * ì§ì› ë°ì´í„° ì²˜ë¦¬ Step (ì •ìƒ ë°ì´í„°)
     */
    @Bean
    public Step importEmployeeStep(
            @Qualifier("employeeCsvReader") ItemReader<EmployeeCsvDto> reader,
            ItemProcessor<EmployeeCsvDto, Employee> processor,
            ItemWriter<Employee> writer) {
        
        return new StepBuilder("importEmployeeStep", jobRepository)
                .<EmployeeCsvDto, Employee>chunk(3, transactionManager)  // ì²­í¬ í¬ê¸° 3
                .reader(reader)
                .processor(processor)
                .writer(writer)
                .build();
    }
    
    /**
     * ì—ëŸ¬ ì²˜ë¦¬ê°€ í¬í•¨ëœ Job (ì‹¤ìŠµìš©)
     */
    @Bean
    public Job importEmployeeWithErrorHandlingJob(Step importEmployeeWithErrorHandlingStep) {
        return new JobBuilder("importEmployeeWithErrorHandlingJob", jobRepository)
                .incrementer(new RunIdIncrementer())
                .flow(importEmployeeWithErrorHandlingStep)
                .end()
                .build();
    }
    
    /**
     * ì—ëŸ¬ ì²˜ë¦¬ê°€ í¬í•¨ëœ Step
     */
    @Bean
    public Step importEmployeeWithErrorHandlingStep(
            @Qualifier("employeeCsvReaderWithErrors") ItemReader<EmployeeCsvDto> reader,
            ItemProcessor<EmployeeCsvDto, Employee> processor,
            ItemWriter<Employee> writer) {
        
        return new StepBuilder("importEmployeeWithErrorHandlingStep", jobRepository)
                .<EmployeeCsvDto, Employee>chunk(5, transactionManager)
                .reader(reader)
                .processor(processor)
                .writer(writer)
                // ì—ëŸ¬ ì²˜ë¦¬ ì„¤ì •
                .faultTolerant()
                .skipLimit(10)                                    // ìµœëŒ€ 10ê°œ ì•„ì´í…œ ìŠ¤í‚µ í—ˆìš©
                .skip(Exception.class)                            // ëª¨ë“  ì˜ˆì™¸ì— ëŒ€í•´ ìŠ¤í‚µ ì²˜ë¦¬
                .listener(employeeSkipListener())                 // ìŠ¤í‚µ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                .build();
    }
    
    /**
     * ìŠ¤í‚µëœ ì•„ì´í…œ ë¡œê¹…ì„ ìœ„í•œ ë¦¬ìŠ¤ë„ˆ
     */
    @Bean
    public EmployeeSkipListener employeeSkipListener() {
        return new EmployeeSkipListener();
    }
}
```

### ìŠ¤í‚µ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„
```java
package com.example.batchtutorial.config;

import com.example.batchtutorial.dto.EmployeeCsvDto;
import com.example.batchtutorial.entity.Employee;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.listener.SkipListenerSupport;
import org.springframework.stereotype.Component;

/**
 * ìŠ¤í‚µëœ ì•„ì´í…œì— ëŒ€í•œ ë¡œê¹…ì„ ì²˜ë¦¬í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ
 */
@Slf4j
@Component
public class EmployeeSkipListener extends SkipListenerSupport<EmployeeCsvDto, Employee> {
    
    @Override
    public void onSkipInRead(Throwable t) {
        log.error("âŒ Skip occurred in Reader: {}", t.getMessage());
    }
    
    @Override
    public void onSkipInProcess(EmployeeCsvDto item, Throwable t) {
        log.error("âŒ Skip occurred in Processor for item [{}]: {}", 
                item.getFirstName() + " " + item.getLastName(), t.getMessage());
    }
    
    @Override
    public void onSkipInWrite(Employee item, Throwable t) {
        log.error("âŒ Skip occurred in Writer for item [{}]: {}", 
                item.getFullName(), t.getMessage());
    }
}
```

## ğŸ® ë°°ì¹˜ ì‹¤í–‰ ì»¨íŠ¸ë¡¤ëŸ¬

### ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ í™•ì¥
```java
package com.example.batchtutorial.controller;

import com.example.batchtutorial.entity.Employee;
import com.example.batchtutorial.repository.EmployeeRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.JobParametersBuilder;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/batch")
public class EmployeeBatchController {
    
    @Autowired
    private JobLauncher jobLauncher;
    
    @Autowired
    @Qualifier("importEmployeeJob")
    private Job importEmployeeJob;
    
    @Autowired
    @Qualifier("importEmployeeWithErrorHandlingJob")
    private Job importEmployeeWithErrorHandlingJob;
    
    @Autowired
    private EmployeeRepository employeeRepository;
    
    /**
     * ì •ìƒ ì§ì› ë°ì´í„° ë°°ì¹˜ ì‹¤í–‰
     */
    @PostMapping("/employees")
    public String runEmployeeBatch() {
        try {
            JobParameters jobParameters = new JobParametersBuilder()
                    .addLong("timestamp", System.currentTimeMillis())
                    .toJobParameters();
            
            var jobExecution = jobLauncher.run(importEmployeeJob, jobParameters);
            
            return String.format(
                "âœ… ì§ì› ë°ì´í„° ë°°ì¹˜ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤! " +
                "Job ID: %d, ìƒíƒœ: %s", 
                jobExecution.getId(), 
                jobExecution.getStatus()
            );
            
        } catch (Exception e) {
            log.error("ì§ì› ë°°ì¹˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return "âŒ ë°°ì¹˜ ì‹¤í–‰ ì‹¤íŒ¨: " + e.getMessage();
        }
    }
    
    /**
     * ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨ ë°°ì¹˜ ì‹¤í–‰
     */
    @PostMapping("/employees-with-errors")
    public String runEmployeeBatchWithErrors() {
        try {
            JobParameters jobParameters = new JobParametersBuilder()
                    .addLong("timestamp", System.currentTimeMillis())
                    .toJobParameters();
            
            var jobExecution = jobLauncher.run(importEmployeeWithErrorHandlingJob, jobParameters);
            
            return String.format(
                "âœ… ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨ ì§ì› ë°°ì¹˜ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤! " +
                "Job ID: %d, ìƒíƒœ: %s", 
                jobExecution.getId(), 
                jobExecution.getStatus()
            );
            
        } catch (Exception e) {
            log.error("ì—ëŸ¬ ì²˜ë¦¬ ë°°ì¹˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return "âŒ ë°°ì¹˜ ì‹¤í–‰ ì‹¤íŒ¨: " + e.getMessage();
        }
    }
    
    /**
     * ì €ì¥ëœ ì§ì› ë°ì´í„° ì¡°íšŒ
     */
    @GetMapping("/employees")
    public List<Employee> getAllEmployees() {
        return employeeRepository.findAll();
    }
    
    /**
     * ë¶€ì„œë³„ í†µê³„ ì¡°íšŒ
     */
    @GetMapping("/employees/statistics")
    public Map<String, Object> getEmployeeStatistics() {
        List<Employee> allEmployees = employeeRepository.findAll();
        
        long totalCount = allEmployees.size();
        BigDecimal totalSalary = allEmployees.stream()
                .map(Employee::getSalary)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        BigDecimal averageSalary = totalCount > 0 ? 
                totalSalary.divide(BigDecimal.valueOf(totalCount), 2, BigDecimal.ROUND_HALF_UP) : 
                BigDecimal.ZERO;
        
        // ë¶€ì„œë³„ ì§ì› ìˆ˜
        Map<String, Long> departmentCounts = allEmployees.stream()
                .collect(java.util.stream.Collectors.groupingBy(
                    Employee::getDepartment,
                    java.util.stream.Collectors.counting()
                ));
        
        return Map.of(
            "totalEmployees", totalCount,
            "totalSalary", totalSalary,
            "averageSalary", averageSalary,
            "departmentCounts", departmentCounts
        );
    }
    
    /**
     * ë°ì´í„° ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ìš©)
     */
    @DeleteMapping("/employees")
    public String clearEmployeeData() {
        long deletedCount = employeeRepository.count();
        employeeRepository.deleteAll();
        return String.format("âœ… %dê°œì˜ ì§ì› ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", deletedCount);
    }
}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
```bash
./gradlew bootRun
```

### 2. ë°°ì¹˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
```bash
# ì •ìƒ ë°ì´í„° ë°°ì¹˜ ì‹¤í–‰
curl -X POST http://localhost:8080/batch/employees

# ì—ëŸ¬ ë°ì´í„° í¬í•¨ ë°°ì¹˜ ì‹¤í–‰
curl -X POST http://localhost:8080/batch/employees-with-errors

# ì§ì› ë°ì´í„° ì¡°íšŒ
curl http://localhost:8080/batch/employees

# í†µê³„ ì •ë³´ ì¡°íšŒ
curl http://localhost:8080/batch/employees/statistics

# ë°ì´í„° ì´ˆê¸°í™”
curl -X DELETE http://localhost:8080/batch/employees
```

### 3. ì‹¤í–‰ ê²°ê³¼ í™•ì¸
```json
// GET /batch/employees/statistics ì‘ë‹µ ì˜ˆì‹œ
{
  "totalEmployees": 8,
  "totalSalary": 44500000,
  "averageSalary": 5562500.00,
  "departmentCounts": {
    "ê°œë°œíŒ€": 4,
    "ë§ˆì¼€íŒ…íŒ€": 2,
    "ì¸ì‚¬íŒ€": 2
  }
}
```

## âœ… í•™ìŠµ ì²´í¬í¬ì¸íŠ¸

### ì™„ë£Œí•´ì•¼ í•  ì‘ì—…ë“¤:
- [ ] Employee ì—”í‹°í‹° ë° Repository êµ¬í˜„
- [ ] CSV íŒŒì¼ ItemReader ì„¤ì •
- [ ] ë°ì´í„° ê²€ì¦ ë° ë³€í™˜ ItemProcessor êµ¬í˜„
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ItemWriter êµ¬í˜„
- [ ] ì²­í¬ ê¸°ë°˜ ë°°ì¹˜ Job ì„¤ì •
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ìŠ¤í‚µ ë¡œì§ êµ¬í˜„
- [ ] ë°°ì¹˜ ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
- [ ] í†µê³„ ì •ë³´ ì¡°íšŒ API í…ŒìŠ¤íŠ¸

### í™•ì¸ ì§ˆë¬¸:
1. **ì²­í¬ í¬ê¸°ë¥¼ 3ìœ¼ë¡œ ì„¤ì •í•œ ì´ìœ ëŠ”?**
2. **ItemProcessorì—ì„œ nullì„ ë°˜í™˜í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?**
3. **ìŠ¤í‚µê³¼ ì¬ì‹œë„ì˜ ì°¨ì´ì ì€ ë¬´ì—‡ì¸ê°€ìš”?**
4. **ì™œ DTOì™€ Entityë¥¼ ë¶„ë¦¬í–ˆë‚˜ìš”?**

ğŸ‰ **ì¶•í•˜í•©ë‹ˆë‹¤!** ì‹¤ì œ CSV íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì™„ì „í•œ ë°°ì¹˜ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ” ë” ê³ ê¸‰ ê¸°ëŠ¥ë“¤ì„ í•™ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤!