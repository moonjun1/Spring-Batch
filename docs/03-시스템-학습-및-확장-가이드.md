# 03. ì‹œìŠ¤í…œ í•™ìŠµ ë° í™•ì¥ ê°€ì´ë“œ

## ğŸ¯ í•™ìŠµ ëª©í‘œ

ì´ ë¬¸ì„œëŠ” í˜„ì¬ Spring Batch ì‹œìŠ¤í…œì„ **ì–´ë–»ê²Œ ê³µë¶€í•˜ê³ **, **ì–´ë–»ê²Œ í™•ì¥í•  ìˆ˜ ìˆëŠ”ì§€** ìƒì„¸í•˜ê²Œ ì•ˆë‚´í•©ë‹ˆë‹¤.

## ğŸ“š ì½”ë“œ ë¶„ì„ì„ í†µí•œ í•™ìŠµ ë°©ë²•

### 1. í•µì‹¬ í´ë˜ìŠ¤ ë¶„ì„ ìˆœì„œ

#### 1ë‹¨ê³„: ê¸°ë³¸ êµ¬ì¡° ì´í•´
```java
// 1. ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤ ë¶„ì„
SpringBatchApplication.java
â†’ @SpringBootApplication ì–´ë…¸í…Œì´ì…˜ì˜ ì˜ë¯¸
â†’ main() ë©”ì„œë“œì˜ ì—­í• 
â†’ Spring Boot ìë™ ì„¤ì • ë©”ì»¤ë‹ˆì¦˜

// 2. ì„¤ì • í´ë˜ìŠ¤ ë¶„ì„
BatchConfig.java, WeatherBatchConfig.java
â†’ @Configuration ì–´ë…¸í…Œì´ì…˜
â†’ @Bean ë©”ì„œë“œë“¤ì˜ ì˜ì¡´ì„± ì£¼ì…
â†’ Job, Step, ItemReader/Processor/Writer ê´€ê³„
```

#### 2ë‹¨ê³„: ë°°ì¹˜ ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ë¶„ì„

##### Job ë¶„ì„ (ì‘ì—… ë‹¨ìœ„):
```java
@Bean
public Job importUserJob(Step step1) {
    return new JobBuilder("importUserJob", jobRepository)
            .start(step1)  // ì‹œì‘ Step ì§€ì •
            .build();
}

// í•™ìŠµ í¬ì¸íŠ¸:
// - Jobì€ ì—¬ëŸ¬ Stepì„ í¬í•¨í•  ìˆ˜ ìˆìŒ
// - JobRepositoryëŠ” ë°°ì¹˜ ì‹¤í–‰ ë©”íƒ€ë°ì´í„° ê´€ë¦¬
// - JobBuilder íŒ¨í„´ ì‚¬ìš©ë²•
```

##### Step ë¶„ì„ (ì²˜ë¦¬ ë‹¨ê³„):
```java
@Bean
public Step step1(ItemReader<Person> reader,
                  ItemProcessor<Person, Person> processor,
                  ItemWriter<Person> writer) {
    return new StepBuilder("step1", jobRepository)
            .<Person, Person>chunk(3, transactionManager)  // ì²­í¬ í¬ê¸° = 3
            .reader(reader)      // ë°ì´í„° ì½ê¸°
            .processor(processor) // ë°ì´í„° ì²˜ë¦¬
            .writer(writer)      // ë°ì´í„° ì“°ê¸°
            .build();
}

// í•™ìŠµ í¬ì¸íŠ¸:
// - ì²­í¬ ê¸°ë°˜ ì²˜ë¦¬: 3ê°œì”© ë¬¶ì–´ì„œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬
// - Reader â†’ Processor â†’ Writer íŒŒì´í”„ë¼ì¸
// - ê° ì»´í¬ë„ŒíŠ¸ì˜ ë…ë¦½ì„±ê³¼ ì¬ì‚¬ìš©ì„±
```

#### 3ë‹¨ê³„: ê° ì»´í¬ë„ŒíŠ¸ ì‹¬í™” ë¶„ì„

##### ItemReader ë¶„ì„:
```java
// CSV íŒŒì¼ ì½ê¸°
@Bean
public FlatFileItemReader<Person> reader() {
    return new FlatFileItemReaderBuilder<Person>()
            .name("personItemReader")
            .resource(new ClassPathResource("sample-data.csv"))
            .delimited()  // CSV êµ¬ë¶„ì ì„¤ì •
            .names(new String[]{"firstName", "lastName", "email"})
            .fieldSetMapper(new BeanWrapperFieldSetMapper<Person>() {{
                setTargetType(Person.class);  // ë§¤í•‘ ëŒ€ìƒ í´ë˜ìŠ¤
            }})
            .build();
}

// í•™ìŠµ í•´ë³¼ ì :
// 1. ë‹¤ë¥¸ ë°ì´í„° ì†ŒìŠ¤ëŠ”? (Database, JSON, XML)
// 2. íŒŒì¼ ê²½ë¡œ ë™ì  ì„¤ì • ë°©ë²•ì€?
// 3. ì—ëŸ¬ ë°œìƒ ì‹œ ì²˜ë¦¬ ë°©ë²•ì€?
```

##### ItemProcessor ë¶„ì„:
```java
// ë‚ ì”¨ ë°ì´í„° ì²˜ë¦¬ ì˜ˆì‹œ
@Bean
public ItemProcessor<String, WeatherData> weatherProcessor() {
    return cityCode -> {
        try {
            // 1. ì™¸ë¶€ API í˜¸ì¶œ
            WeatherApiResponse response = weatherApiService
                .getCurrentWeather(cityCode).block();
            
            // 2. ë°ì´í„° ë³€í™˜
            WeatherData weatherData = convertToWeatherData(response, cityCode);
            
            // 3. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ì´ìƒ ê¸°í›„ íƒì§€)
            detectAbnormalWeather(weatherData);
            
            return weatherData;
        } catch (Exception e) {
            log.error("Processing failed for {}: {}", cityCode, e.getMessage());
            return null;  // null ë°˜í™˜ ì‹œ í•´ë‹¹ ì•„ì´í…œ ìŠ¤í‚µ
        }
    };
}

// í•™ìŠµ í•´ë³¼ ì :
// 1. ë³µì¡í•œ ë³€í™˜ ë¡œì§ êµ¬í˜„ ë°©ë²•
// 2. ì™¸ë¶€ API í˜¸ì¶œ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
// 3. ì¡°ê±´ë¶€ ì²˜ë¦¬ (íŠ¹ì • ì¡°ê±´ì—ì„œë§Œ ì²˜ë¦¬)
// 4. ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë©€í‹°ìŠ¤ë ˆë“œ ì ìš©
```

### 2. ì‹¤ì „ ì½”ë“œ ì‹¤ìŠµ ë°©ë²•

#### ë””ë²„ê¹…ì„ í†µí•œ í•™ìŠµ:
```java
// 1. IDEì—ì„œ ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ì„¤ì •
@Bean
public ItemProcessor<Person, Person> processor() {
    return (item) -> {
        // â†“ ì—¬ê¸°ì— ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ì„¤ì •
        log.info("Processing person: {}", item);
        
        // ë°ì´í„° ë³€í™˜ ë¡œì§ ì‹¤í–‰ ê³¼ì • ê´€ì°°
        String upperFirstName = item.getFirstName().toUpperCase();
        item.setFirstName(upperFirstName);
        
        return item;  // â† ë°˜í™˜ê°’ í™•ì¸
    };
}
```

#### ë¡œê·¸ ë¶„ì„:
```bash
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„ ë¡œê·¸ í™•ì¸
./gradlew bootRun

# ì£¼ìš” í™•ì¸ í¬ì¸íŠ¸:
# - Job ì‹¤í–‰ ì‹œì‘/ì¢…ë£Œ ë¡œê·¸
# - Step ì‹¤í–‰ ê³¼ì •
# - ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬ ë¡œê·¸
# - ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤
```

## ğŸ› ï¸ ì‹œìŠ¤í…œ í™•ì¥ ë°©ë²•

### 1. ìƒˆë¡œìš´ ë°°ì¹˜ Job ì¶”ê°€

#### ì˜ˆì‹œ: ì£¼ì‹ ë°ì´í„° ë°°ì¹˜ ì¶”ê°€
```java
@Configuration
public class StockBatchConfig {
    
    @Autowired
    private JobRepository jobRepository;
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    // 1. ìƒˆë¡œìš´ Job ì •ì˜
    @Bean
    public Job collectStockDataJob(Step stockCollectionStep) {
        return new JobBuilder("collectStockDataJob", jobRepository)
                .start(stockCollectionStep)
                .build();
    }
    
    // 2. Step ì •ì˜
    @Bean
    public Step stockCollectionStep() {
        return new StepBuilder("stockCollectionStep", jobRepository)
                .<String, StockData>chunk(5, transactionManager)
                .reader(stockSymbolReader())      // ì£¼ì‹ ì‹¬ë³¼ ë¦¬ë”
                .processor(stockDataProcessor())   // ì£¼ì‹ API í˜¸ì¶œ
                .writer(stockDataWriter())        // DB ì €ì¥
                .build();
    }
    
    // 3. ì£¼ì‹ ì‹¬ë³¼ ì½ê¸°
    @Bean
    public ItemReader<String> stockSymbolReader() {
        List<String> symbols = List.of("AAPL", "GOOGL", "MSFT", "AMZN");
        
        return new ItemReader<String>() {
            private int index = 0;
            
            @Override
            public String read() {
                if (index < symbols.size()) {
                    return symbols.get(index++);
                }
                return null;
            }
        };
    }
    
    // 4. ì£¼ì‹ ë°ì´í„° ì²˜ë¦¬
    @Bean
    public ItemProcessor<String, StockData> stockDataProcessor() {
        return symbol -> {
            // Yahoo Finance API ë˜ëŠ” Alpha Vantage API í˜¸ì¶œ
            // JSON ì‘ë‹µì„ StockData ì—”í‹°í‹°ë¡œ ë³€í™˜
            return stockApiService.getStockData(symbol);
        };
    }
    
    // 5. DB ì €ì¥
    @Bean
    public ItemWriter<StockData> stockDataWriter() {
        return chunk -> {
            List<? extends StockData> stockDataList = chunk.getItems();
            stockDataRepository.saveAll(stockDataList);
        };
    }
}
```

#### í•„ìš”í•œ ì¶”ê°€ í´ë˜ìŠ¤ë“¤:
```java
// StockData ì—”í‹°í‹°
@Entity
@Table(name = "stock_data")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class StockData {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String symbol;       // ì£¼ì‹ ì‹¬ë³¼
    private String companyName;  // íšŒì‚¬ëª…
    private Double currentPrice; // í˜„ì¬ ê°€ê²©
    private Double openPrice;    // ì‹œê°€
    private Double highPrice;    // ê³ ê°€
    private Double lowPrice;     // ì €ê°€
    private Long volume;         // ê±°ë˜ëŸ‰
    private LocalDateTime collectedAt;
}

// StockDataRepository
@Repository
public interface StockDataRepository extends JpaRepository<StockData, Long> {
    List<StockData> findBySymbolOrderByCollectedAtDesc(String symbol);
    List<StockData> findTop10ByOrderByCollectedAtDesc();
}

// StockApiService
@Service
public class StockApiService {
    
    private final WebClient webClient;
    
    public StockApiService() {
        this.webClient = WebClient.builder()
            .baseUrl("https://api.example.com/stock")
            .build();
    }
    
    public StockData getStockData(String symbol) {
        // ì‹¤ì œ API í˜¸ì¶œ ë¡œì§ êµ¬í˜„
        return webClient.get()
            .uri("/quote/{symbol}", symbol)
            .retrieve()
            .bodyToMono(StockData.class)
            .block();
    }
}
```

### 2. ìŠ¤ì¼€ì¤„ë§ ì¶”ê°€

#### Cron í‘œí˜„ì‹ìœ¼ë¡œ ìë™ ì‹¤í–‰:
```java
@Component
@EnableScheduling
public class BatchScheduler {
    
    @Autowired
    private JobLauncher jobLauncher;
    
    @Autowired
    private Job collectWeatherDataJob;
    
    @Autowired
    private Job collectStockDataJob;
    
    // ë§¤ì‹œê°„ ì •ê°ì— ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘
    @Scheduled(cron = "0 0 * * * *")
    public void runWeatherBatch() {
        try {
            JobParameters params = new JobParametersBuilder()
                .addLong("time", System.currentTimeMillis())
                .toJobParameters();
                
            jobLauncher.run(collectWeatherDataJob, params);
        } catch (Exception e) {
            log.error("Weather batch scheduling failed", e);
        }
    }
    
    // í‰ì¼ ì˜¤ì „ 9ì‹œì— ì£¼ì‹ ë°ì´í„° ìˆ˜ì§‘
    @Scheduled(cron = "0 0 9 * * MON-FRI")
    public void runStockBatch() {
        try {
            JobParameters params = new JobParametersBuilder()
                .addLong("time", System.currentTimeMillis())
                .toJobParameters();
                
            jobLauncher.run(collectStockDataJob, params);
        } catch (Exception e) {
            log.error("Stock batch scheduling failed", e);
        }
    }
}
```

### 3. ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„ ë¡œì§ ì¶”ê°€

#### ì¬ì‹œë„ ì •ì±… ì„¤ì •:
```java
@Bean
public Step resilientWeatherStep() {
    return new StepBuilder("resilientWeatherStep", jobRepository)
            .<String, WeatherData>chunk(3, transactionManager)
            .reader(cityReader())
            .processor(weatherProcessor())
            .writer(weatherWriter())
            // ì¬ì‹œë„ ì„¤ì •
            .faultTolerant()
            .retry(Exception.class)        // ëª¨ë“  ì˜ˆì™¸ì— ëŒ€í•´ ì¬ì‹œë„
            .retryLimit(3)                 // ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
            // íŠ¹ì • ì˜ˆì™¸ëŠ” ê±´ë„ˆë›°ê¸°
            .skip(IllegalArgumentException.class)
            .skipLimit(5)                  // ìµœëŒ€ 5ê°œê¹Œì§€ ê±´ë„ˆë›°ê¸°
            .build();
}
```

#### ì‹¤íŒ¨í•œ ì•„ì´í…œ ë³„ë„ ì²˜ë¦¬:
```java
@Bean
public Step stepWithFailureHandling() {
    return new StepBuilder("stepWithFailureHandling", jobRepository)
            .<String, WeatherData>chunk(3, transactionManager)
            .reader(cityReader())
            .processor(weatherProcessor())
            .writer(weatherWriter())
            .faultTolerant()
            // ì‹¤íŒ¨í•œ ì•„ì´í…œì„ ë³„ë„ íŒŒì¼ë¡œ ì €ì¥
            .skipListener(new SkipListener<String, WeatherData>() {
                @Override
                public void onSkipInProcessing(String item, Throwable t) {
                    log.error("Skipped processing for city: {}, Error: {}", 
                        item, t.getMessage());
                    // ì‹¤íŒ¨ ë¡œê·¸ë¥¼ íŒŒì¼ì´ë‚˜ ë³„ë„ í…Œì´ë¸”ì— ì €ì¥
                    saveFailedItem(item, t.getMessage());
                }
            })
            .build();
}
```

### 4. ì„±ëŠ¥ ìµœì í™”

#### ë©€í‹°ìŠ¤ë ˆë“œ ì²˜ë¦¬:
```java
@Bean
public Step parallelWeatherStep() {
    return new StepBuilder("parallelWeatherStep", jobRepository)
            .<String, WeatherData>chunk(3, transactionManager)
            .reader(cityReader())
            .processor(weatherProcessor())
            .writer(weatherWriter())
            // ë©€í‹°ìŠ¤ë ˆë“œ ì„¤ì •
            .taskExecutor(taskExecutor())
            .throttleLimit(4)  // ë™ì‹œ ì‹¤í–‰ ìŠ¤ë ˆë“œ ìˆ˜
            .build();
}

@Bean
public TaskExecutor taskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(4);
    executor.setMaxPoolSize(8);
    executor.setQueueCapacity(25);
    executor.setThreadNamePrefix("batch-thread-");
    executor.initialize();
    return executor;
}
```

#### íŒŒí‹°ì…˜ ì²˜ë¦¬ (ëŒ€ìš©ëŸ‰ ë°ì´í„°):
```java
@Bean
public Step partitionStep() {
    return new StepBuilder("partitionStep", jobRepository)
            .partitioner("slaveStep", partitioner())
            .step(slaveStep())
            .gridSize(4)  // 4ê°œ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„í• 
            .taskExecutor(taskExecutor())
            .build();
}

@Bean
public Partitioner partitioner() {
    return new Partitioner() {
        @Override
        public Map<String, ExecutionContext> partition(int gridSize) {
            Map<String, ExecutionContext> result = new HashMap<>();
            
            // ë„ì‹œ ëª©ë¡ì„ 4ê°œ ê·¸ë£¹ìœ¼ë¡œ ë¶„í• 
            List<String> cities = List.of("Seoul", "Busan", "Incheon", 
                                         "Daegu", "Daejeon", "Gwangju", 
                                         "Ulsan", "Suwon");
            
            int partitionSize = cities.size() / gridSize;
            
            for (int i = 0; i < gridSize; i++) {
                ExecutionContext context = new ExecutionContext();
                int start = i * partitionSize;
                int end = (i == gridSize - 1) ? cities.size() : (i + 1) * partitionSize;
                
                context.put("cities", cities.subList(start, end));
                result.put("partition" + i, context);
            }
            
            return result;
        }
    };
}
```

## ğŸ” ê³ ê¸‰ í•™ìŠµ ë°©í–¥

### 1. Spring Batch Admin ì—°ë™
- ë°°ì¹˜ ì‘ì—… ëª¨ë‹ˆí„°ë§ ì›¹ UI
- ì‹¤í–‰ ì´ë ¥ ë° ìƒíƒœ ê´€ë¦¬
- ì‹¤íŒ¨í•œ Job ì¬ì‹œì‘ ê¸°ëŠ¥

### 2. ë©”ì‹œì§€ í ì—°ë™ (RabbitMQ, Kafka)
```java
// Kafkaë¥¼ í†µí•œ ë°°ì¹˜ íŠ¸ë¦¬ê±°
@KafkaListener(topics = "weather-batch-trigger")
public void handleBatchTrigger(String message) {
    // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë°°ì¹˜ ì‹¤í–‰
    jobLauncher.run(collectWeatherDataJob, createJobParameters());
}
```

### 3. í´ë¼ìš°ë“œ í™˜ê²½ ë°°í¬
- AWS Batch, Google Cloud Dataflow
- Kubernetes CronJob
- Docker ì»¨í…Œì´ë„ˆí™”

### 4. ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
```java
// ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ë¥¼ ìœ„í•œ JPA ë°°ì¹˜ ì„¤ì •
@Bean
public JpaItemWriter<WeatherData> optimizedWriter() {
    JpaItemWriter<WeatherData> writer = new JpaItemWriter<>();
    writer.setEntityManagerFactory(entityManagerFactory);
    // ë°°ì¹˜ ì‚½ì… ìµœì í™”
    return writer;
}
```

## ğŸ“– ì¶”ì²œ í•™ìŠµ ë¦¬ì†ŒìŠ¤

### ê³µì‹ ë¬¸ì„œ:
- Spring Batch Reference Documentation
- Spring Boot Batch ê°€ì´ë“œ

### ì‹¤ìŠµ í”„ë¡œì íŠ¸ ì•„ì´ë””ì–´:
1. **ë¡œê·¸ íŒŒì¼ ë¶„ì„ ë°°ì¹˜**: ì›¹ ì„œë²„ ë¡œê·¸ íŒŒì‹± ë° í†µê³„ ìƒì„±
2. **ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ë°°ì¹˜**: Legacy ì‹œìŠ¤í…œì—ì„œ ì‹ ê·œ ì‹œìŠ¤í…œìœ¼ë¡œ ë°ì´í„° ì´ì „
3. **ë¦¬í¬íŠ¸ ìƒì„± ë°°ì¹˜**: ì¼ê°„/ì£¼ê°„/ì›”ê°„ ë¦¬í¬íŠ¸ ìë™ ìƒì„±
4. **ë°ì´í„° ì •ì œ ë°°ì¹˜**: ì¤‘ë³µ ë°ì´í„° ì œê±°, ë°ì´í„° í’ˆì§ˆ í–¥ìƒ

ì´ ê°€ì´ë“œë¥¼ í†µí•´ í˜„ì¬ ì‹œìŠ¤í…œì„ ì™„ì „íˆ ì´í•´í•˜ê³  ìì‹ ë§Œì˜ ë°°ì¹˜ ì‹œìŠ¤í…œìœ¼ë¡œ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.