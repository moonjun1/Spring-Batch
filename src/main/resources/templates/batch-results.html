<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배치 실행 결과 - Spring Batch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="text-center text-success">
                    <i class="fas fa-chart-bar me-2"></i>배치 실행 결과
                </h1>
                <p class="text-center text-muted">날씨 통계 및 알림 배치의 실행 결과를 확인하세요</p>
            </div>
        </div>

        <!-- 알림 메시지 -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 요약 통계 -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h5 class="card-title">총 통계</h5>
                        <h2 class="mb-0" th:text="${totalStatistics} + '개'">0개</h2>
                        <small>생성된 날씨 통계</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-warning text-dark h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-bell fa-2x mb-2"></i>
                        <h5 class="card-title">총 알림</h5>
                        <h2 class="mb-0" th:text="${totalAlerts} + '개'">0개</h2>
                        <small>생성된 날씨 알림</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-day fa-2x mb-2"></i>
                        <h5 class="card-title">오늘 통계</h5>
                        <h2 class="mb-0" th:text="${#lists.size(todayStatistics)} + '개'">0개</h2>
                        <small>오늘자 통계 데이터</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-danger text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                        <h5 class="card-title">활성 알림</h5>
                        <h2 class="mb-0" th:text="${#lists.size(recentAlerts)} + '개'">0개</h2>
                        <small>해결되지 않은 알림</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 최근 통계 데이터 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>최근 날씨 통계 (최근 7일)
                        </h5>
                        <a href="/batch-results/statistics" class="btn btn-light btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>상세보기
                        </a>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(recentStatistics)}" class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <p>생성된 통계 데이터가 없습니다.<br>배치를 먼저 실행해주세요.</p>
                        </div>
                        <div th:if="${not #lists.isEmpty(recentStatistics)}" class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>날짜</th>
                                        <th>도시</th>
                                        <th>평균온도</th>
                                        <th>최고/최저</th>
                                        <th>습도</th>
                                        <th>주요 날씨</th>
                                        <th>이상기후</th>
                                        <th>데이터수</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="stat : ${recentStatistics}">
                                        <td th:text="${stat.statisticsDate}">2024-01-01</td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${stat.cityName}">서울</span>
                                        </td>
                                        <td>
                                            <span th:if="${stat.avgTemperature != null}" 
                                                  th:text="${#numbers.formatDecimal(stat.avgTemperature, 0, 1)} + '°C'">-</span>
                                        </td>
                                        <td>
                                            <small class="text-success" 
                                                   th:if="${stat.maxTemperature != null}"
                                                   th:text="${#numbers.formatDecimal(stat.maxTemperature, 0, 1)} + '°C'">-</small>
                                            /
                                            <small class="text-primary" 
                                                   th:if="${stat.minTemperature != null}"
                                                   th:text="${#numbers.formatDecimal(stat.minTemperature, 0, 1)} + '°C'">-</small>
                                        </td>
                                        <td th:text="${stat.avgHumidity != null ? stat.avgHumidity + '%' : '-'}">-</td>
                                        <td>
                                            <span class="badge bg-info" th:text="${stat.dominantWeather ?: '미정'}">-</span>
                                        </td>
                                        <td>
                                            <span th:if="${stat.abnormalWeatherCount != null and stat.abnormalWeatherCount > 0}" 
                                                  class="badge bg-danger" 
                                                  th:text="${stat.abnormalWeatherCount} + '건'">-</span>
                                            <span th:unless="${stat.abnormalWeatherCount != null and stat.abnormalWeatherCount > 0}" 
                                                  class="text-muted">정상</span>
                                        </td>
                                        <td th:text="${stat.totalRecords ?: 0} + '개'">0개</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 최근 알림 데이터 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-bell me-2"></i>활성 날씨 알림
                        </h5>
                        <a href="/batch-results/alerts" class="btn btn-dark btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>상세보기
                        </a>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(recentAlerts)}" class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>활성화된 알림이 없습니다.<br>모든 상황이 정상입니다!</p>
                        </div>
                        <div th:if="${not #lists.isEmpty(recentAlerts)}" class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>발생시간</th>
                                        <th>도시</th>
                                        <th>알림유형</th>
                                        <th>수준</th>
                                        <th>제목</th>
                                        <th>감지값</th>
                                        <th>발송상태</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="alert : ${recentAlerts}">
                                        <td th:text="${#temporals.format(alert.alertTime, 'MM-dd HH:mm')}">01-01 12:00</td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${alert.cityName}">서울</span>
                                        </td>
                                        <td>
                                            <span th:switch="${alert.alertType?.name()}" class="badge">
                                                <span th:case="'HEAT_WAVE'" class="badge bg-danger">폭염</span>
                                                <span th:case="'COLD_WAVE'" class="badge bg-info">한파</span>
                                                <span th:case="'HEAVY_RAIN'" class="badge bg-primary">호우</span>
                                                <span th:case="'ABNORMAL_WEATHER'" class="badge bg-warning text-dark">이상기후</span>
                                                <span th:case="*" class="badge bg-secondary" th:text="${alert.alertType?.koreanName}">기타</span>
                                            </span>
                                        </td>
                                        <td>
                                            <span th:switch="${alert.alertLevel?.name()}" class="badge">
                                                <span th:case="'EMERGENCY'" class="badge bg-danger">긴급</span>
                                                <span th:case="'WARNING'" class="badge bg-warning text-dark">경보</span>
                                                <span th:case="'ADVISORY'" class="badge bg-info">주의보</span>
                                                <span th:case="'NOTICE'" class="badge bg-secondary">주의</span>
                                                <span th:case="*" class="badge bg-light text-dark" th:text="${alert.alertLevel?.koreanName}">-</span>
                                            </span>
                                        </td>
                                        <td th:text="${alert.alertTitle}">알림 제목</td>
                                        <td>
                                            <span th:if="${alert.triggerValue != null}" 
                                                  class="fw-bold" 
                                                  th:text="${#numbers.formatDecimal(alert.triggerValue, 0, 1)}">-</span>
                                        </td>
                                        <td>
                                            <span th:if="${alert.isSent}" class="badge bg-success">발송완료</span>
                                            <span th:unless="${alert.isSent}" class="badge bg-secondary">대기중</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 네비게이션 -->
        <div class="text-center">
            <a href="/batch-test" class="btn btn-primary me-2">
                <i class="fas fa-cogs me-1"></i>배치 테스트로 돌아가기
            </a>
            <a href="/" class="btn btn-outline-primary">
                <i class="fas fa-home me-1"></i>메인 페이지
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>