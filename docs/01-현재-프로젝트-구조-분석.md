# 01. í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”

ì´ Spring Batch í”„ë¡œì íŠ¸ëŠ” **CSV íŒŒì¼ ì²˜ë¦¬**ì™€ **ì‹¤ì‹œê°„ ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘** ë‘ ê°€ì§€ ë°°ì¹˜ ì‹œìŠ¤í…œì„ í¬í•¨í•©ë‹ˆë‹¤.

```
springBatch/
â”œâ”€â”€ src/main/java/com/springbatch/
â”‚   â”œâ”€â”€ SpringBatchApplication.java       # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚   â”œâ”€â”€ config/                          # ì„¤ì • í´ë˜ìŠ¤ë“¤
â”‚   â”‚   â”œâ”€â”€ BatchConfig.java             # CSV ë°°ì¹˜ ì„¤ì •
â”‚   â”‚   â””â”€â”€ WeatherBatchConfig.java      # ë‚ ì”¨ ë°°ì¹˜ ì„¤ì •
â”‚   â”œâ”€â”€ controller/                      # ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬
â”‚   â”‚   â”œâ”€â”€ BatchController.java         # ë°°ì¹˜ ì‹¤í–‰ ì»¨íŠ¸ë¡¤ëŸ¬
â”‚   â”‚   â””â”€â”€ WeatherController.java       # ë‚ ì”¨ API ì»¨íŠ¸ë¡¤ëŸ¬
â”‚   â”œâ”€â”€ entity/                          # JPA ì—”í‹°í‹°
â”‚   â”‚   â”œâ”€â”€ Person.java                  # ì‚¬ìš©ì ì—”í‹°í‹°
â”‚   â”‚   â””â”€â”€ WeatherData.java             # ë‚ ì”¨ ë°ì´í„° ì—”í‹°í‹°
â”‚   â”œâ”€â”€ dto/                             # ë°ì´í„° ì „ì†¡ ê°ì²´
â”‚   â”‚   â””â”€â”€ WeatherApiResponse.java      # ë‚ ì”¨ API ì‘ë‹µ DTO
â”‚   â”œâ”€â”€ repository/                      # ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
â”‚   â”‚   â”œâ”€â”€ PersonRepository.java        # ì‚¬ìš©ì ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬
â”‚   â”‚   â””â”€â”€ WeatherDataRepository.java   # ë‚ ì”¨ ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬
â”‚   â””â”€â”€ service/                         # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚       â””â”€â”€ WeatherApiService.java       # ë‚ ì”¨ API ì„œë¹„ìŠ¤
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ templates/                       # Thymeleaf í…œí”Œë¦¿
â”‚   â”‚   â”œâ”€â”€ index.html                   # ë©”ì¸ í˜ì´ì§€
â”‚   â”‚   â””â”€â”€ weather-dashboard.html       # ë‚ ì”¨ ëŒ€ì‹œë³´ë“œ
â”‚   â”œâ”€â”€ application.properties           # ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
â”‚   â””â”€â”€ sample-data.csv                 # ìƒ˜í”Œ CSV ë°ì´í„°
â”œâ”€â”€ .env                                # í™˜ê²½ ë³€ìˆ˜ (API í‚¤)
â””â”€â”€ build.gradle                        # Gradle ë¹Œë“œ ì„¤ì •
```

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ êµ¬ì„±ìš”ì†Œ

### 1. CSV ë°°ì¹˜ ì‹œìŠ¤í…œ (BatchConfig.java)

```java
@Configuration
public class BatchConfig {
    
    // Job: ì „ì²´ ë°°ì¹˜ ì‘ì—… ì •ì˜
    @Bean
    public Job importUserJob(Step step1) {
        return new JobBuilder("importUserJob", jobRepository)
                .start(step1)
                .build();
    }
    
    // Step: ì‹¤ì œ ì²˜ë¦¬ ë‹¨ê³„
    @Bean
    public Step step1(ItemReader<Person> reader,
                      ItemProcessor<Person, Person> processor,
                      ItemWriter<Person> writer) {
        return new StepBuilder("step1", jobRepository)
                .<Person, Person>chunk(3, transactionManager)
                .reader(reader)      // CSV íŒŒì¼ ì½ê¸°
                .processor(processor) // ë°ì´í„° ë³€í™˜/ê²€ì¦
                .writer(writer)      // ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
                .build();
    }
}
```

**ì²˜ë¦¬ íë¦„:**
1. **ItemReader**: `sample-data.csv` íŒŒì¼ì—ì„œ ì‚¬ìš©ì ë°ì´í„° ì½ê¸°
2. **ItemProcessor**: ë°ì´í„° ê²€ì¦ ë° ë³€í™˜ (ì´ë©”ì¼ í˜•ì‹ ì²´í¬ ë“±)
3. **ItemWriter**: H2 ë°ì´í„°ë² ì´ìŠ¤ì— Person ì—”í‹°í‹°ë¡œ ì €ì¥

### 2. ë‚ ì”¨ ë°°ì¹˜ ì‹œìŠ¤í…œ (WeatherBatchConfig.java)

```java
@Configuration
public class WeatherBatchConfig {
    
    // ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘ Job
    @Bean
    public Job collectWeatherDataJob(Step weatherCollectionStep) {
        return new JobBuilder("collectWeatherDataJob", jobRepository)
                .start(weatherCollectionStep)
                .build();
    }
    
    // ë‚ ì”¨ ë°ì´í„° ì²˜ë¦¬ Step
    @Bean
    public Step weatherCollectionStep(ItemReader<String> cityReader,
                                     ItemProcessor<String, WeatherData> weatherProcessor,
                                     ItemWriter<WeatherData> weatherWriter) {
        return new StepBuilder("weatherCollectionStep", jobRepository)
                .<String, WeatherData>chunk(3, transactionManager)
                .reader(cityReader)      // ë„ì‹œ ëª©ë¡ ìƒì„±
                .processor(weatherProcessor) // API í˜¸ì¶œ ë° ë°ì´í„° ë³€í™˜
                .writer(weatherWriter)   // ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
                .build();
    }
}
```

**ì²˜ë¦¬ íë¦„:**
1. **ItemReader**: ì „êµ­ ì£¼ìš” 8ê°œ ë„ì‹œ ëª©ë¡ ìƒì„± (Seoul, Busan, Incheon ë“±)
2. **ItemProcessor**: ê° ë„ì‹œë³„ OpenWeatherMap API í˜¸ì¶œ â†’ WeatherData ì—”í‹°í‹° ë³€í™˜
3. **ItemWriter**: H2 ë°ì´í„°ë² ì´ìŠ¤ì— ë‚ ì”¨ ë°ì´í„° ì €ì¥
4. **ì´ìƒ ê¸°í›„ íƒì§€**: ì „ë‚  ëŒ€ë¹„ ì˜¨ë„ ë³€í™”ëŸ‰ ê³„ì‚° (20ë„ ì´ìƒ ì°¨ì´ ì‹œ ì´ìƒ ê¸°í›„ë¡œ íŒì •)

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

### Core Technologies
- **Spring Boot 3.5.5**: ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë ˆì„ì›Œí¬
- **Spring Batch 5.x**: ë°°ì¹˜ ì²˜ë¦¬ í”„ë ˆì„ì›Œí¬
- **Java 17**: í”„ë¡œê·¸ë˜ë° ì–¸ì–´
- **Gradle**: ë¹Œë“œ ë„êµ¬

### Data & Persistence
- **H2 Database**: ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤
- **Spring Data JPA**: ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
- **Hibernate**: ORM í”„ë ˆì„ì›Œí¬

### Web & API
- **Spring WebFlux**: ë¹„ë™ê¸° REST í´ë¼ì´ì–¸íŠ¸ (WebClient)
- **Thymeleaf**: ì„œë²„ì‚¬ì´ë“œ í…œí”Œë¦¿ ì—”ì§„
- **Spring Web MVC**: ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬

### External APIs
- **OpenWeatherMap API**: ì‹¤ì‹œê°„ ë‚ ì”¨ ë°ì´í„°
- **API Key**: í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬ (.env íŒŒì¼)

## ğŸ“Š ë°ì´í„° ëª¨ë¸

### Person Entity (ì‚¬ìš©ì ë°ì´í„°)
```java
@Entity
@Table(name = "person")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Person {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "first_name")
    private String firstName;
    
    @Column(name = "last_name") 
    private String lastName;
    
    private String email;
}
```

### WeatherData Entity (ë‚ ì”¨ ë°ì´í„°)
```java
@Entity
@Table(name = "weather_data")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class WeatherData {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String cityCode;           // ë„ì‹œ ì½”ë“œ
    
    @Column(nullable = false)
    private String cityName;           // ë„ì‹œëª… (í•œêµ­ì–´)
    
    @Column(nullable = false)
    private Double temperature;        // í˜„ì¬ ì˜¨ë„
    
    private Double feelsLike;          // ì²´ê° ì˜¨ë„
    private Double tempMin;            // ìµœì € ì˜¨ë„
    private Double tempMax;            // ìµœê³  ì˜¨ë„
    private Integer humidity;          // ìŠµë„
    private Integer pressure;          // ê¸°ì••
    private Double windSpeed;          // í’ì†
    private Integer windDirection;     // í’í–¥
    private Integer cloudiness;        // êµ¬ë¦„ëŸ‰
    private Double rainfall;           // ê°•ìˆ˜ëŸ‰ (1ì‹œê°„)
    private Double snowfall;           // ì ì„¤ëŸ‰ (1ì‹œê°„)
    private Integer visibility;        // ê°€ì‹œê±°ë¦¬
    
    private String weatherMain;        // ë‚ ì”¨ ìƒíƒœ (Rain, Clear ë“±)
    private String weatherDescription; // ë‚ ì”¨ ì„¤ëª…
    
    @Column(nullable = false)
    private LocalDateTime collectedAt; // ë°ì´í„° ìˆ˜ì§‘ ì‹œê°„
    
    private LocalDateTime weatherTime; // ë‚ ì”¨ ê´€ì¸¡ ì‹œê°„
    
    // ì´ìƒ ê¸°í›„ íƒì§€ í•„ë“œ
    private Boolean isAbnormal = false;     // ì´ìƒ ê¸°í›„ ì—¬ë¶€
    private Double temperatureChange;       // ì „ë‚  ëŒ€ë¹„ ì˜¨ë„ ë³€í™”ëŸ‰
}
```

## ğŸ”„ ë°°ì¹˜ ì‹¤í–‰ íë¦„

### 1. CSV ë°°ì¹˜ ì‹¤í–‰
```
ì‚¬ìš©ì ìš”ì²­ â†’ BatchController.runJob() 
â†’ JobLauncher.run(importUserJob) 
â†’ Step1 ì‹¤í–‰ 
â†’ CSV íŒŒì¼ ì½ê¸° â†’ ë°ì´í„° ì²˜ë¦¬ â†’ DB ì €ì¥
```

### 2. ë‚ ì”¨ ë°°ì¹˜ ì‹¤í–‰
```
ì‚¬ìš©ì ìš”ì²­ â†’ WeatherController.collectWeatherData()
â†’ JobLauncher.run(collectWeatherDataJob)
â†’ WeatherCollectionStep ì‹¤í–‰
â†’ ë„ì‹œ ëª©ë¡ ìƒì„± â†’ API í˜¸ì¶œ â†’ ë°ì´í„° ë³€í™˜ â†’ ì´ìƒê¸°í›„ íƒì§€ â†’ DB ì €ì¥
```

## ğŸ¯ í•µì‹¬ íŠ¹ì§•

### 1. ì²­í¬ ê¸°ë°˜ ì²˜ë¦¬
- ëŒ€ëŸ‰ ë°ì´í„°ë¥¼ 3ê°œì”© ë¬¶ì–´ì„œ ì²˜ë¦¬ (ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±)
- íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ì»¤ë°‹

### 2. ì´ìƒ ê¸°í›„ íƒì§€ ì•Œê³ ë¦¬ì¦˜
```java
private void detectAbnormalWeather(WeatherData currentData) {
    // ì „ë‚  ë™ì¼ ì‹œê°„ëŒ€ ë°ì´í„° ì¡°íšŒ
    var yesterdayDataList = weatherDataRepository
        .findByCityCodeAndCollectedAtBetweenOrderByCollectedAtDesc(
            currentData.getCityCode(), yesterdayStart, yesterdayEnd);
    
    if (!yesterdayDataList.isEmpty()) {
        WeatherData yesterdayData = yesterdayDataList.get(0);
        double temperatureChange = currentData.getTemperature() - yesterdayData.getTemperature();
        
        // ì „ë‚  ëŒ€ë¹„ 20ë„ ì´ìƒ ë³€í™” ì‹œ ì´ìƒ ê¸°í›„ë¡œ íŒë‹¨
        if (Math.abs(temperatureChange) >= 20.0) {
            currentData.setIsAbnormal(true);
        }
    }
}
```

### 3. ì™¸ë¶€ API ì—°ë™
- WebClientë¥¼ ì‚¬ìš©í•œ ë¹„ë™ê¸° HTTP í†µì‹ 
- í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ API í‚¤ ê´€ë¦¬
- ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…

### 4. ì›¹ ëŒ€ì‹œë³´ë“œ
- Thymeleaf í…œí”Œë¦¿ ê¸°ë°˜ ì‹¤ì‹œê°„ ë°ì´í„° ì‹œê°í™”
- ë°˜ì‘í˜• ë””ìì¸
- AJAX ê¸°ë°˜ ë°°ì¹˜ ì‹¤í–‰

## ğŸ” ë³´ì•ˆ ë° ì„¤ì •

### í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ (.env)
```properties
WEATHER_API_KEY=4336a7df2186cc57454035002475e06a
```

### ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • (application.properties)
```properties
# H2 Database
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.username=sa
spring.datasource.password=
spring.h2.console.enabled=true

# JPA
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true

# Batch
spring.batch.job.enabled=false
```

## ğŸ“ˆ ì„±ëŠ¥ ë° ëª¨ë‹ˆí„°ë§

### ë¡œê¹… ì‹œìŠ¤í…œ
- Slf4j + Logback ê¸°ë°˜ ë¡œê¹…
- ë°°ì¹˜ ì‹¤í–‰ ìƒíƒœ ë° ì—ëŸ¬ ì¶”ì 
- API í˜¸ì¶œ ê²°ê³¼ ëª¨ë‹ˆí„°ë§

### ë©”íŠ¸ë¦­ìŠ¤
- ë°°ì¹˜ ì‹¤í–‰ ì‹œê°„
- API ì‘ë‹µ ì‹œê°„
- ë°ì´í„° ì²˜ë¦¬ëŸ‰
- ì´ìƒ ê¸°í›„ ê°ì§€ ê±´ìˆ˜

ì´ êµ¬ì¡°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ì–‘í•œ ë°°ì¹˜ ì‹œìŠ¤í…œì„ í™•ì¥í•  ìˆ˜ ìˆìœ¼ë©°, ê° ì»´í¬ë„ŒíŠ¸ëŠ” ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë° ìš´ì˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.